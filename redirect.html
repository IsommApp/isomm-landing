<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reindirizzamento in corso...</title>
    
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Funzione per impostare i cookie tramite Sovrn
            function initializeSovrnCookies(callback) {
                // Apriamo una finestra temporanea per caricare il link Sovrn
                const popup = window.open('https://sovrn.co/zv1pijk', '_blank', 'width=1,height=1,left=-9999,top=-9999');
                
                if (!popup) {
                    console.error("Il popup è stato bloccato. Consenti i popup per procedere.");
                    // Fallback: reindirizza direttamente se il popup è bloccato
                    callback();
                    return;
                }

                // Aspettiamo che la finestra completi il caricamento
                const checkPopup = setInterval(() => {
                    if (popup.closed || popup.location.href.includes('tannico.it')) {
                        clearInterval(checkPopup);
                        popup.close(); // Chiudiamo la finestra
                        callback(); // Procediamo con il reindirizzamento
                    }
                }, 500); // Controlliamo ogni 500ms

                // Timeout di sicurezza: chiudiamo dopo 5 secondi se non succede nulla
                setTimeout(() => {
                    clearInterval(checkPopup);
                    if (!popup.closed) {
                        popup.close();
                    }
                    callback();
                }, 5000);
            }

            // Funzione per eseguire il reindirizzamento dinamico
            function performRedirect() {
                const urlParams = new URLSearchParams(window.location.search);
                const query = urlParams.get('query');

                if (!query) {
                    window.location.href = 'https://isomm.it';
                    return;
                }

                let tannicoUrl;
                if (query.toLowerCase() === 'promozioni') {
                    tannicoUrl = 'https://tannico.it/tutte-le-promo.html';
                } else {
                    let normalizedQuery = query;
                    try {
                        while (normalizedQuery.includes('%')) {
                            normalizedQuery = decodeURIComponent(normalizedQuery);
                        }
                    } catch (e) {
                        console.error("Errore nella decodifica di " + query + ": " + e);
                    }
                    
                    const encodedQuery = encodeURIComponent(normalizedQuery).replace(/%20/g, '%20');
                    tannicoUrl = `https://www.tannico.it/catalogsearch/result/?q=${encodedQuery}`;
                }

                // Creazione del link monetizzato con Sovrn Redirect API
                const affiliateUrl = `https://redirect.viglink.com?key=97f790c7e654001fe141e3dae100e8d1&u=${encodeURIComponent(tannicoUrl)}`;
                
                // Redirezione
                window.location.replace(affiliateUrl);
            }

            // Esegui la chiamata a Sovrn per impostare i cookie, poi procedi con il reindirizzamento
            initializeSovrnCookies(performRedirect);
        });
    </script>
</head>
<body>
    <p>Reindirizzamento in corso...</p>
    <script type="text/javascript">
        var vglnk = { key: '97f790c7e654001fe141e3dae100e8d1' };
        (function(d, t) {
            var s = d.createElement(t);
            s.type = 'text/javascript';
            s.async = true;
            s.src = '//cdn.viglink.com/api/vglnk.js';
            var r = d.getElementsByTagName(t)[0];
            r.parentNode.insertBefore(s, r);
        }(document, 'script'));
    </script>
</body>
</html>
